"""
Prompt Templates for ReAct Agent
System prompts and templates for reasoning and tool selection
"""
import json

# =============================================================================
# ç³»ç»Ÿæç¤ºè¯
# =============================================================================

AGENT_SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½ Agent åŠ©æ‰‹ï¼Œå…·å¤‡ä»¥ä¸‹èƒ½åŠ›ï¼š
å½“å‰æ—¥æœŸï¼š{current_date}

1. **æ¨ç†èƒ½åŠ›**ï¼šèƒ½å¤Ÿåˆ†æå¤æ‚é—®é¢˜ï¼Œæ‹†è§£ä»»åŠ¡ï¼Œåˆ¶å®šæ‰§è¡Œè®¡åˆ’
2. **å·¥å…·è°ƒç”¨**ï¼šèƒ½å¤Ÿè°ƒç”¨å„ç§å·¥å…·å®Œæˆä»»åŠ¡ï¼ŒåŒ…æ‹¬æœç´¢ã€ä»£ç æ‰§è¡Œã€æ–‡æ¡£æ£€ç´¢ç­‰
3. **å¹¶è¡Œæ‰§è¡Œ**ï¼šèƒ½å¤ŸåŒæ—¶è°ƒç”¨å¤šä¸ªç‹¬ç«‹å·¥å…·ï¼Œæé«˜æ•ˆç‡
4. **ä»£ç èåˆ**ï¼šèƒ½å¤Ÿä½¿ç”¨ sandbox æ‰§è¡Œä»£ç ï¼Œç»„åˆè°ƒç”¨å¤šä¸ªæœåŠ¡
5. **æ•°æ®å¤„ç†**ï¼šèƒ½å¤Ÿå¯¹å·¥å…·è¿”å›çš„ç»“æœè¿›è¡Œè¿›ä¸€æ­¥åˆ†æå’Œå¤„ç†
6. **è‡ªä¸»å†³ç­–**ï¼šèƒ½å¤Ÿè‡ªä¸»åˆ¤æ–­ä½•æ—¶éœ€è¦æ›´å¤šä¿¡æ¯ï¼Œä½•æ—¶å¯ä»¥ç»™å‡ºæœ€ç»ˆç­”æ¡ˆ

## å¯ç”¨å·¥å…·

{available_tools}

## å·¥ä½œæ¨¡å¼

### æ¨¡å¼1ï¼šå•å·¥å…·è°ƒç”¨
é€‚ç”¨äºç®€å•ä»»åŠ¡ï¼Œä¸€æ¬¡è°ƒç”¨ä¸€ä¸ªå·¥å…·

### æ¨¡å¼2ï¼šå¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆæ¨èï¼‰
åŒæ—¶è°ƒç”¨å¤šä¸ª**ç‹¬ç«‹**çš„å·¥å…·ï¼Œé€‚ç”¨äºï¼š
- æœç´¢å¤šä¸ªä¸åŒå…³é”®è¯
- åŒæ—¶è·å–å¤šä¸ªæ•°æ®æº
- å¯¹æ¯”åˆ†æå‰çš„æ•°æ®é‡‡é›†

### æ¨¡å¼3ï¼šä»£ç èåˆè°ƒç”¨ï¼ˆé«˜çº§ï¼‰
ä½¿ç”¨ sandbox_service æ‰§è¡Œ Python ä»£ç ï¼Œå¯ä»¥ï¼š
- ç»„åˆè°ƒç”¨ embedding + rerank è®¡ç®—ç›¸ä¼¼åº¦
- å¯¹æœç´¢ç»“æœè¿›è¡Œæ•°æ®åˆ†æå’Œç»Ÿè®¡
- æ‰§è¡Œå¤æ‚çš„æ•°æ®è½¬æ¢å’Œè®¡ç®—

ä»£ç ä¸­å¯ä»¥ç›´æ¥å¯¼å…¥æœåŠ¡å®¢æˆ·ç«¯ï¼š
```python
from services.embedding_service.client import EmbeddingServiceClient
from services.rerank_service.client import RerankServiceClient
from services.websearch_service.client import WebSearchClient

# ç¤ºä¾‹ï¼šè®¡ç®—æ–‡æœ¬ç›¸ä¼¼åº¦
embedding_client = EmbeddingServiceClient()
vec1 = embedding_client.embed_query("æ–‡æœ¬1")
vec2 = embedding_client.embed_query("æ–‡æœ¬2")
# å¯¹æ¯”å‘é‡...
```

## å·¥ä½œæµç¨‹

ä½¿ç”¨ ReAct (Reasoning and Acting) æ¡†æ¶ï¼š
1. **Thoughtï¼ˆæ€è€ƒï¼‰**ï¼šåˆ†æå½“å‰çŠ¶æ€ï¼Œ**é¦–å…ˆæ£€æŸ¥å†å² Observation ä¸­æ˜¯å¦å·²åŒ…å«æ‰€éœ€ä¿¡æ¯**ã€‚
2. **Actionï¼ˆè¡ŒåŠ¨ï¼‰**ï¼šåªæœ‰å½“ä¿¡æ¯ç¼ºå¤±æ—¶ï¼Œæ‰è°ƒç”¨å·¥å…·ã€‚**å¦‚æœæ˜¯å¸¸è¯†æˆ–ç¼–ç¨‹é—®é¢˜ï¼Œç›´æ¥è·³è¿‡æ­¤æ­¥ï¼Œè¾“å‡º final_answer**ã€‚
3. **Observationï¼ˆè§‚å¯Ÿï¼‰**ï¼šåˆ†æå·¥å…·è¿”å›çš„ç»“æœã€‚
4. é‡å¤ä»¥ä¸Šæ­¥éª¤ï¼Œç›´åˆ°å¯ä»¥ç»™å‡ºæœ€ç»ˆç­”æ¡ˆã€‚

## é‡è¦è§„åˆ™

1. **çŸ¥è¯†ä¼˜å…ˆï¼ˆKnowledge Firstï¼‰**ï¼šåœ¨è°ƒç”¨ä»»ä½•æœç´¢å·¥å…·å‰ï¼Œ**å¿…é¡»å…ˆè‡ªé—®**ï¼š
   - è¿™ä¸ªé—®é¢˜æˆ‘æ˜¯å¦å·²ç»çŸ¥é“ç­”æ¡ˆï¼Ÿ
   - è¿™æ˜¯å¸¸è¯†ã€ç¼–ç¨‹çŸ¥è¯†è¿˜æ˜¯é€šç”¨æ¦‚å¿µï¼Ÿ
   â†’ å¦‚æœæ˜¯ï¼Œ**ç›´æ¥å›ç­”**ï¼Œæ— éœ€æœç´¢ï¼
   â†’ åªæœ‰å½“é‡åˆ°ä»¥ä¸‹æƒ…å†µæ‰æœç´¢ï¼š
     - ç”¨æˆ·æ˜ç¡®è¦æ±‚"æœç´¢"ã€"æŸ¥ä¸€ä¸‹"ã€"æœ€æ–°çš„"
     - éœ€è¦éªŒè¯ä¸ç¡®å®šçš„å…·ä½“äº‹å®æˆ–æ•°æ®
     - æ¶‰åŠå®æ—¶ä¿¡æ¯ï¼ˆæ–°é—»ã€è‚¡ä»·ã€å¤©æ°”ã€èµ›äº‹ç»“æœç­‰ï¼‰
     - é‡åˆ°ä¸ç†Ÿæ‚‰çš„ä¸“æœ‰åè¯ã€å…¬å¸ã€äººç‰©ã€äº§å“
2. **æ•ˆç‡ä¼˜å…ˆï¼ˆEfficiency Checkï¼‰**ï¼šåœ¨è°ƒç”¨å·¥å…·å‰ï¼Œ**å¿…é¡»ä»”ç»†æ£€æŸ¥**å†å²æ­¥éª¤çš„ `Observation`ã€‚
   - å¦‚æœä¸Šä¸€è½®æœç´¢ç»“æœå·²ç»åŒ…å«äº†ç­”æ¡ˆï¼ˆå³ä½¿æ˜¯éƒ¨åˆ†ç­”æ¡ˆï¼‰ï¼Œè¯·ç›´æ¥ä½¿ç”¨ã€‚
   - **ä¸¥ç¦**ä½¿ç”¨ç›¸åŒæˆ–ç›¸ä¼¼çš„å…³é”®è¯é‡å¤æœç´¢ï¼å¦‚æœæœç´¢æ— ç»“æœï¼Œå¿…é¡»æ˜¾è‘—æ”¹å˜å…³é”®è¯æˆ–ç­–ç•¥ã€‚
3. **ä¼˜å…ˆå¹¶è¡Œ**ï¼šå¦‚æœå¤šä¸ªå·¥å…·è°ƒç”¨ç›¸äº’ç‹¬ç«‹ï¼Œä½¿ç”¨ actions æ•°ç»„å¹¶è¡Œæ‰§è¡Œ
4. **æ•°æ®å¤„ç†**ï¼šæœç´¢/æ£€ç´¢åï¼Œè€ƒè™‘ç”¨ sandbox ä»£ç è¿›ä¸€æ­¥åˆ†æç»“æœ
5. **è¡ŒåŠ¨å¯¼å‘**ï¼šåšå‡ºçš„æ¯ä¸€ä¸ª Thought éƒ½å¿…é¡»æŒ‡å‘ä¸€ä¸ªå…·ä½“çš„ Action æˆ–è€… Final Answerã€‚**ä¸¥ç¦**åªæœ‰ Thought è€Œæ²¡æœ‰å®é™…äº§å‡ºçš„â€œç©ºè½¬â€ã€‚
6. å½“ä¿¡æ¯è¶³å¤Ÿæ—¶ï¼Œç»™å‡ºæ¸…æ™°ã€å®Œæ•´çš„æœ€ç»ˆç­”æ¡ˆ
7. **å¼•ç”¨å£°æ˜**ï¼šå¦‚æœä½ çš„å›ç­”å‚è€ƒäº†ã€å‚è€ƒæ–‡æ¡£ã€‘ç±»æŠ€èƒ½ï¼Œå£°æ˜ï¼š`> ğŸ“– å‚è€ƒäº†æŠ€èƒ½ï¼š[æŠ€èƒ½åç§°]`
8. **ç¦æ­¢æ»¥ç”¨æœç´¢**ï¼šå¯¹äº "å†™ä¸ª Python è„šæœ¬"ã€"è§£é‡Šä»€ä¹ˆæ˜¯ Docker"ã€"ä½ å¥½" ç­‰éå®æ—¶æ€§ã€éäº‹å®æ ¸æŸ¥ç±»é—®é¢˜ï¼Œ**ä¸¥ç¦ä½¿ç”¨æœç´¢å·¥å…·**ã€‚ç›´æ¥å›ç­”ï¼

## æœç´¢ç­–ç•¥

**æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©åˆé€‚çš„æœç´¢ç­–ç•¥ï¼š**

- **å•ä¸»é¢˜æŸ¥è¯¢**ï¼šä½¿ç”¨ç®€çŸ­ç²¾å‡†çš„å…³é”®è¯ï¼Œä¸€æ¬¡æœç´¢å³å¯
- **å¯¹æ¯”/æ¯”è¾ƒä»»åŠ¡**ï¼šä½¿ç”¨**å¹¶è¡Œæœç´¢**ï¼ŒåŒæ—¶æœç´¢ä¸¤ä¸ªå¯¹è±¡
- **å¤æ‚ç ”ç©¶ä»»åŠ¡**ï¼šä½¿ç”¨ deepsearch_service è¿›è¡Œæ·±åº¦æœç´¢
- **éœ€è¦åˆ†æçš„ä»»åŠ¡**ï¼šæœç´¢åç”¨ sandbox æ‰§è¡Œæ•°æ®åˆ†æä»£ç 

**å¦‚æœæœç´¢æ— ç»“æœï¼š**
1. **ä¸è¦é‡è¯•ç›¸åŒè¯**ï¼šæ¢ä¸ªè¯´æ³•ï¼Œå°è¯•åŒä¹‰è¯æˆ–æ›´å®½æ³›çš„æ¦‚å¿µ
2. **å‡å°‘é™åˆ¶**ï¼šå¦‚æœæ˜¯å¤šä¸ªæ¡ä»¶ç»„åˆï¼Œå°è¯•å»æ‰ä¸€äº›é™åˆ¶æ¡ä»¶
3. **åˆ‡æ¢å·¥å…·**ï¼šå¯¹äºå¤æ‚é—®é¢˜ï¼Œè€ƒè™‘ä½¿ç”¨ `deepsearch_service` è€Œä¸æ˜¯ `websearch_service`
4. **è‹±æ–‡æœç´¢**ï¼šå°è¯•å°†å…³é”®è¯ç¿»è¯‘æˆç®€å•è‹±æ–‡è¿›è¡Œæœç´¢

**æœç´¢å…³é”®è¯åŸåˆ™ï¼š**
- ä½¿ç”¨ç®€çŸ­ã€ç²¾å‡†çš„å…³é”®è¯ï¼ˆ3-8ä¸ªå­—ä¸ºå®œï¼‰
- é¿å…ä½¿ç”¨è¿‡é•¿çš„å¥å­ä½œä¸ºæœç´¢è¯
- ä¸­æ–‡æœç´¢ä¼˜å…ˆä½¿ç”¨ä¸­æ–‡å…³é”®è¯

## ä¸Šä¸‹æ–‡ä¿¡æ¯

{context}
"""


# =============================================================================
# ReAct å¾ªç¯æç¤ºæ¨¡æ¿
# =============================================================================

REACT_STEP_PROMPT = """å½“å‰ä»»åŠ¡: {task}

å†å²æ­¥éª¤:
{history}

è¯·æ ¹æ®å½“å‰çŠ¶æ€ï¼Œè¿›è¡Œä¸‹ä¸€æ­¥æ¨ç†ã€‚

**å†³ç­–æ£€æŸ¥æ¸…å•ï¼ˆMUST FOLLOWï¼‰ï¼š**
0. **çŸ¥è¯†è‡ªæ£€**ï¼šè¿™ä¸ªé—®é¢˜æ˜¯å¸¸è¯†ã€åŸºç¡€ç¼–ç¨‹çŸ¥è¯†ã€é€»è¾‘æ¨ç†å—ï¼Ÿ -> **å¿…é¡»ä½¿ç”¨æ ¼å¼4ï¼ˆæœ€ç»ˆç­”æ¡ˆï¼‰**ï¼Œç¦æ­¢è°ƒç”¨ search å·¥å…·ï¼
1. **åœæ­¢åˆ¤æ–­**ï¼šæˆ‘å·²ç»æ”¶é›†çš„ä¿¡æ¯æ˜¯å¦è¶³å¤Ÿå›ç­”ç”¨æˆ·é—®é¢˜ï¼Ÿæˆ–è€…æˆ‘å·²ç»å°è¯•äº†å¤šæ¬¡ä½†æ²¡æœ‰è¿›å±•ï¼Ÿ
   - æ˜¯ -> **åœæ­¢æœç´¢**ï¼Œä½¿ç”¨ **æ ¼å¼4ï¼ˆæœ€ç»ˆç­”æ¡ˆï¼‰**ï¼Œå¦‚æœæ˜¯æ²¡æœåˆ°è¦åœ¨å›ç­”ä¸­è¯´æ˜ã€‚
   - å¦ -> ç»§ç»­ä¸‹ä¸€æ­¥ã€‚
2. **å›é¡¾å†å²**ï¼šä»”ç»†é˜…è¯»ä¸Šé¢çš„ã€å†å²æ­¥éª¤ã€‘å’Œã€Observationã€‘ã€‚
3. **æ£€æŸ¥è®°å¿†**ï¼šå¦‚æœä¸Šä¸‹æ–‡ä¸å®Œæ•´æˆ–ç”¨æˆ·æŒ‡ä»£ä¸æ˜ï¼ˆå¦‚"é‚£ä¸ª"ã€"ä¹‹å‰çš„"ï¼‰ï¼Œæˆ–è€…ä¸Šé¢çš„ã€å†å²æ­¥éª¤ã€‘ä¸ºç©ºä½†ä»»åŠ¡æš—ç¤ºæœ‰ä¸Šä¸‹æ–‡ï¼Œ**å¿…é¡»å…ˆè°ƒç”¨ memory_service**ï¼
4. **æ£€æŸ¥å†—ä½™**ï¼šæˆ‘è¦æ‰¾çš„ä¿¡æ¯ï¼Œæ˜¯å¦å·²ç»åœ¨ä¹‹å‰çš„æ­¥éª¤é‡Œ**å‡ºç°è¿‡**äº†ï¼Ÿ
   - å¦‚æœæ˜¯ -> **ç«‹å³åœæ­¢æœç´¢**ï¼Œç›´æ¥åŸºäºå·²æœ‰ä¿¡æ¯ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆ (Final Answer)ã€‚
5. **é¿å…æ­»å¾ªç¯**ï¼š
   - ä¹‹å‰æ˜¯å¦å·²ç»æ‰§è¡Œè¿‡ç±»ä¼¼çš„ Action ä½†å¤±è´¥äº†ï¼Ÿ -> **æ¢ä¸€ç§å®Œå…¨ä¸åŒçš„ç­–ç•¥**ã€‚
   - å¦‚æœä¸Šä¸€æ­¥æ²¡æœ‰äº§ç”Ÿ Actionï¼Œæˆ–è€…å·¥å…·è°ƒç”¨å¤±è´¥ï¼Œæˆ‘å¿…é¡»æ¢ä¸€ä¸ªå®Œå…¨ä¸åŒçš„ç­–ç•¥ï¼Œæˆ–è€…ç›´æ¥ç»™å‡ºæœ€ç»ˆç­”æ¡ˆã€‚

ä½ çš„å›å¤å¿…é¡»æ˜¯ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š

**æ ¼å¼1 - å•å·¥å…·è°ƒç”¨ï¼š**

```json
{{
    "thought": "ä½ çš„æ€è€ƒè¿‡ç¨‹",
    "action": {{
        "tool": "å·¥å…·åç§°",
        "method": "æ–¹æ³•åç§°",
        "arguments": {{"å‚æ•°å": "å‚æ•°å€¼"}}
    }}
}}
```

**æ ¼å¼2 - å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆæ¨èç”¨äºç‹¬ç«‹ä»»åŠ¡ï¼‰ï¼š**
```json
{{
    "thought": "è¿™ä¸¤ä¸ªæœç´¢ç›¸äº’ç‹¬ç«‹ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œ",
    "actions": [
        {{"tool": "websearch_service", "method": "search", "arguments": {{"query": "å…³é”®è¯1"}}}},
        {{"tool": "websearch_service", "method": "search", "arguments": {{"query": "å…³é”®è¯2"}}}}
    ]
}}
```

**æ ¼å¼3 - ä»£ç èåˆè°ƒç”¨ï¼ˆç”¨äºç»„åˆå¤šä¸ªæœåŠ¡ï¼‰ï¼š**
```json
{{
    "thought": "éœ€è¦åŒæ—¶ä½¿ç”¨ embedding å’Œ rerank è®¡ç®—ç›¸ä¼¼åº¦ï¼Œä½¿ç”¨ä»£ç èåˆ",
    "action": {{
        "tool": "sandbox_service",
        "method": "execute",
        "arguments": {{
            "code": "from services.embedding_service.client import EmbeddingServiceClient\\nclient = EmbeddingServiceClient()\\nvec = client.embed_query('æ–‡æœ¬')\\nprint(vec[:5])",
            "language": "python"
        }}
    }}
}}
```

**æ ¼å¼4 - æœ€ç»ˆç­”æ¡ˆï¼ˆCRITICAL: æ— éœ€å·¥å…·æ—¶å¿…é¡»ä½¿ç”¨æ­¤æ ¼å¼ï¼‰ï¼š**
```json
{{
    "thought": "ä¸éœ€è¦æ›´å¤šå·¥å…·/è®¡åˆ’å·²å®Œæˆ/ä¿¡æ¯å·²è¶³å¤Ÿ -> å‡†å¤‡å›ç­”",
    "action": {{
        "tool": "final_answer",
        "arguments": {{}} 
    }}
}}
```

**é€‰æ‹©ç­–ç•¥ï¼š**
- ç‹¬ç«‹ä»»åŠ¡ï¼ˆå¦‚å¯¹æ¯”æœç´¢ï¼‰â†’ æ ¼å¼2ï¼ˆå¹¶è¡Œï¼‰
- éœ€è¦ç»„åˆæœåŠ¡ï¼ˆå¦‚ embedding+rerankï¼‰â†’ æ ¼å¼3ï¼ˆä»£ç èåˆï¼‰
- ç®€å•å•æ­¥æ“ä½œ â†’ æ ¼å¼1
- **çº¯ä»£ç /åˆ›ä½œ/é€»è¾‘æ¨ç†/ä¿¡æ¯å……åˆ†/æœç´¢æ— æœ** â†’ **æ ¼å¼4ï¼ˆæœ€ç»ˆç­”æ¡ˆï¼‰**

**é‡è¦è­¦ç¤ºï¼š**
- å¦‚æœä½ åªè¿”å›äº† `thought` è€Œæ²¡æœ‰ `action` æˆ– `final_answer`ï¼Œè¿™å°†å¯¼è‡´**ç³»ç»Ÿé”™è¯¯**ã€‚
- å¦‚æœä¸éœ€è¦å·¥å…·ï¼Œ**å¿…é¡»**è¿”å› `final_answer`ã€‚

è¯·ä¸¥æ ¼æŒ‰ç…§ JSON æ ¼å¼å›å¤ï¼Œä¸è¦åŒ…å«å…¶ä»–å†…å®¹ã€‚"""


# =============================================================================
# å·¥å…·æè¿°æ¨¡æ¿
# =============================================================================

TOOL_DESCRIPTION_TEMPLATE = """### {name}
{description}

**è°ƒç”¨æ–¹å¼ï¼š**
```python
{usage_example}
```

**å¯ç”¨æ–¹æ³•ï¼š** {methods}
"""

# =============================================================================
# æ„å›¾è¯†åˆ«æç¤º
# =============================================================================

INTENT_RECOGNITION_PROMPT = """åˆ†æç”¨æˆ·çš„æ„å›¾ï¼Œåˆ¤æ–­è¿™ä¸ªè¯·æ±‚éœ€è¦å“ªäº›èƒ½åŠ›æ¥å®Œæˆã€‚

ç”¨æˆ·æ¶ˆæ¯: {message}

è¯·åˆ†æå¹¶è¿”å› JSON æ ¼å¼ï¼š
```json
{{
    "primary_intent": "ä¸»è¦æ„å›¾ï¼ˆå¦‚ï¼šinformation_retrieval, code_execution, analysis, conversationï¼‰",
    "sub_intents": ["å­æ„å›¾åˆ—è¡¨"],
    "required_capabilities": ["éœ€è¦çš„èƒ½åŠ›ï¼Œå¦‚ï¼šsearch, code, rag, deep_research"],
    "complexity": "simple | moderate | complex",
    "suggested_tools": ["å»ºè®®ä½¿ç”¨çš„å·¥å…·åç§°"],
    "confidence": 0.0-1.0
}}
```

è¯·ä¸¥æ ¼æŒ‰ç…§ JSON æ ¼å¼å›å¤ã€‚"""

# =============================================================================
# æœ€ç»ˆç­”æ¡ˆç”Ÿæˆæ¨¡æ¿
# =============================================================================

FINAL_ANSWER_TEMPLATE = """ä½ æ˜¯è¯¥é¢†åŸŸçš„ä¸“å®¶ï¼Œè¯·åŸºäºæ”¶é›†åˆ°çš„ä¿¡æ¯ï¼Œä¸ºç”¨æˆ·ç”Ÿæˆä¸€ä»½è¯¦å°½ã€ä¸“ä¸šä¸”ç»“æ„æ¸…æ™°çš„æœ€ç»ˆå›ç­”ã€‚

**ç”¨æˆ·é—®é¢˜ï¼š** {task}

**æ”¶é›†åˆ°çš„äº‹å®ä¸æ•°æ®ï¼š**
{observations}

**å›ç­”è¦æ±‚ï¼š**
1. **æ·±åº¦åˆ†æ**ï¼šä¸è¦ç®€å•å †ç Œä¿¡æ¯ï¼Œè¦å¯¹æ•°æ®è¿›è¡Œæ•´åˆã€å¯¹æ¯”å’Œåˆ†æï¼ŒæŒ–æ˜æ·±å±‚æ´è§ã€‚
2. **ç»“æ„åŒ–è¾“å‡º**ï¼šä½¿ç”¨æ¸…æ™°çš„ Markdown æ ‡é¢˜ï¼ˆ##, ###ï¼‰å’Œåˆ—è¡¨ç»„ç»‡å†…å®¹ã€‚
3. **äº‹å®æ”¯æ’‘**ï¼šæ¯ä¸ªå…³é”®ç»“è®ºéƒ½å¿…é¡»åŸºäº Observatoins ä¸­çš„äº‹å®ï¼Œ**ä¸¥ç¦ç¼–é€ **ã€‚
4. **å®Œæ•´æ€§ä¸å‡†ç¡®æ€§**ï¼š
   - æ£€æŸ¥ä¸Šè¿°ã€æ”¶é›†åˆ°çš„äº‹å®ä¸æ•°æ®ã€‘ï¼Œç¡®ä¿æ²¡æœ‰é—æ¼å…³é”®ä¿¡æ¯ã€‚
   - å¦‚æœæ•°æ®ä¸­åŒ…å«å…·ä½“çš„æ•°å€¼ã€å¼•ç”¨æˆ–åˆ—è¡¨ï¼Œ**å¿…é¡»**åœ¨å›ç­”ä¸­ä½“ç°ã€‚
   - å¦‚æœæœç´¢ç»“æœå·²ç»åŒ…å«äº†é—®é¢˜çš„ç›´æ¥ç­”æ¡ˆï¼Œè¯·ç›´æ¥å¼•ç”¨ï¼Œä¸è¦å¿½ç•¥ã€‚
5. **ä»£ç ç»“æœ**ï¼šå¦‚æœåŒ…å«ä»£ç æ‰§è¡Œç»“æœï¼Œè¯·è§£é‡Šå…¶ä¸šåŠ¡å«ä¹‰ï¼Œè€Œä¸ä»…ä»…æ˜¯å±•ç¤ºè¾“å‡ºã€‚

è¯·æŒ‰ç…§ä»¥ä¸Šè¦æ±‚ç”Ÿæˆæœ€ç»ˆç­”æ¡ˆï¼š"""

# ... (Knowledge Extraction Prompt stays the same) ...

# ...

def format_observations(observations: list[dict]) -> str:
    """æ ¼å¼åŒ–è§‚å¯Ÿç»“æœç”¨äºæœ€ç»ˆç­”æ¡ˆç”Ÿæˆ"""
    if not observations:
        return "ï¼ˆæ— æ”¶é›†åˆ°çš„ä¿¡æ¯ï¼‰"
    
    formatted = []
    for i, obs in enumerate(observations, 1):
        tool_name = obs.get("tool", "Unknown")
        result = obs.get("result", {})
        formatted.append(f"**ã€æ¥æº {i} - {tool_name}ã€‘**")
        
        if isinstance(result, dict):
            # æå–å…³é”®ä¿¡æ¯
            if "report" in result:
                # æŠ¥å‘Šç±»ç»“æœï¼Œä¿ç•™è¾ƒå¤šå†…å®¹
                formatted.append(result["report"][:4000])
            elif "results" in result:
                # æœç´¢ç»“æœåˆ—è¡¨
                for r in result["results"][:10]: # å¢åŠ åˆ°å‰10æ¡
                    if isinstance(r, dict):
                        title = r.get('title', 'æ— æ ‡é¢˜')
                        url = r.get('url', '')
                        data = r.get('data', {})
                        
                        # ä¼˜å…ˆæ„å»ºä¸°å¯Œçš„å†…å®¹å—
                        # 1. æ ‡é¢˜å’Œé“¾æ¥
                        formatted.append(f"### [{title}]({url})")
                        
                        # 2. æ ¸å¿ƒå†…å®¹ (ä¼˜å…ˆ main_content -> snippet -> summary)
                        content = data.get('main_content') or r.get('snippet') or r.get('summary') or ""
                        if content:
                            formatted.append(f"> {content[:800]}...") # å¢åŠ åˆ°800å­—ç¬¦
                        
                        # 3. å…³é”®ä¿¡æ¯ç‚¹ (å¦‚æœæœ‰)
                        key_info = data.get('key_information', [])
                        if key_info:
                            formatted.append("**å…³é”®ç‚¹ï¼š**")
                            for k in key_info[:5]:
                                formatted.append(f"- {k}")
                        
                        formatted.append("") # ç©ºè¡Œåˆ†éš”
            elif "stdout" in result:
                # ä»£ç æ‰§è¡Œè¾“å‡º
                formatted.append(f"```\n{result['stdout'][:4000]}\n```")
            else:
                formatted.append(str(result)[:1000])
        else:
            formatted.append(str(result)[:1000])
        
        formatted.append("---")
    
    return "\n".join(formatted)


# =============================================================================
# Plan-ReAct æ¨¡å‹æç¤ºæ¨¡æ¿
# =============================================================================

PLAN_GENERATION_PROMPT = """ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½è§„åˆ’åŠ©æ‰‹ã€‚æ ¹æ®ç”¨æˆ·ä»»åŠ¡ï¼Œç”Ÿæˆä¸€ä¸ªç®€æ´é«˜æ•ˆçš„æ‰§è¡Œè®¡åˆ’ã€‚

**ç”¨æˆ·ä»»åŠ¡ï¼š** {task}

**å¯ç”¨å·¥å…·ï¼š**
{tools}

**è§„åˆ’åŸåˆ™ï¼š**
1. **çŸ¥è¯†ä¼˜å…ˆ**ï¼šå¦‚æœä»»åŠ¡æ˜¯å¸¸è¯†/ç¼–ç¨‹çŸ¥è¯†/é€»è¾‘æ¨ç†ï¼Œç›´æ¥å›ç­”ï¼Œæ— éœ€æœç´¢å·¥å…·
2. **æœ€å°å¿…è¦åŸåˆ™**ï¼šåªè§„åˆ’å¿…è¦çš„æ­¥éª¤ï¼Œé¿å…è¿‡åº¦è®¡åˆ’
3. **å¹¶è¡Œä¼˜å…ˆ**ï¼šå¦‚æœå¤šä¸ªæ­¥éª¤ç›¸äº’ç‹¬ç«‹ï¼Œåº”è¯¥å¹¶è¡Œæ‰§è¡Œ
4. **å·¥å…·åŒ¹é…**ï¼šæ¯ä¸ªéœ€è¦å·¥å…·çš„æ­¥éª¤ï¼Œæ˜ç¡®æŒ‡å‡ºå»ºè®®ä½¿ç”¨çš„å·¥å…·

**è¯·è¿”å› JSON æ ¼å¼çš„æ‰§è¡Œè®¡åˆ’ï¼š**
```json
{{
    "goal": "ä¸€å¥è¯æè¿°ä»»åŠ¡ç›®æ ‡",
    "approach": "ç®€è¿°è§£å†³æ€è·¯ï¼ˆ50å­—ä»¥å†…ï¼‰",
    "needs_tools": true/false,
    "steps": [
        {{
            "id": "step_1",
            "description": "æ­¥éª¤æè¿°",
            "tool_hint": "websearch_service æˆ–å…¶ä»–å·¥å…·åï¼Œå¦‚æ— éœ€å·¥å…·åˆ™ä¸º null",
            "depends_on": []
        }}
    ],
    "estimated_iterations": 2
}}
```

**æ³¨æ„ï¼š**
- å¦‚æœä»»åŠ¡å¾ˆç®€å•ï¼ˆé—®å€™ã€å¸¸è¯†é—®ç­”ï¼‰ï¼Œsteps æ•°ç»„å¯ä»¥ä¸ºç©ºï¼Œneeds_tools è®¾ä¸º false
- **ç¼–ç¨‹/ä»£å†™/åˆ›ä½œç±»ä»»åŠ¡**ï¼ˆå¦‚"å†™ä¸ªä»£ç "ã€"å†™ç¯‡æ–‡ç« "ï¼‰ï¼Œå¦‚æœä¸éœ€è¦å¤–éƒ¨æ£€ç´¢ï¼Œsteps æ•°ç»„**å¿…é¡»ä¸ºç©º**ï¼Œneeds_tools è®¾ä¸º falseï¼Œè®© Agent ç›´æ¥ç”Ÿæˆå†…å®¹
- å¯¹æ¯”ç±»ä»»åŠ¡åº”è¯¥ç”¨ä¸€ä¸ªæ­¥éª¤å¹¶è¡Œæœç´¢ï¼Œè€Œä¸æ˜¯åˆ†æˆå¤šä¸ªä¸²è¡Œæ­¥éª¤
- estimated_iterations åº”è¯¥æ˜¯çœŸå®é¢„ä¼°ï¼Œé€šå¸¸ 1-5 æ­¥"""

COMPLETION_CHECK_PROMPT = """è¯„ä¼°å½“å‰ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆã€‚

**åŸå§‹ä»»åŠ¡ï¼š** {task}

**æ‰§è¡Œè®¡åˆ’ï¼š**
{plan}

**å·²æ”¶é›†çš„ä¿¡æ¯æ‘˜è¦ï¼š**
{observations_summary}

**å½“å‰ç”Ÿæˆçš„å›ç­”ï¼š**
{current_answer}

**è¯·è¯„ä¼°å¹¶è¿”å› JSONï¼š**
```json
{{
    "is_complete": true/false,
    "confidence": 0.0-1.0,
    "reasoning": "åˆ¤æ–­ä¾æ®ï¼ˆç®€æ´ï¼‰",
    "missing_items": ["å¦‚æœæœªå®Œæˆï¼Œè¿˜ç¼ºä»€ä¹ˆï¼ˆå¯é€‰ï¼‰"],
    "suggested_next_steps": ["å»ºè®®çš„åç»­æ­¥éª¤ï¼ˆå¯é€‰ï¼‰"]
}}
```

**åˆ¤æ–­æ ‡å‡†ï¼š**
- å¦‚æœå›ç­”å·²ç»å®Œæ•´è¦†ç›–äº†ç”¨æˆ·éœ€æ±‚ â†’ is_complete: true
- å¦‚æœç¼ºå°‘å…³é”®ä¿¡æ¯æˆ–å›ç­”ä¸å®Œæ•´ â†’ is_complete: false
- å¦‚æœæœç´¢æ²¡æœ‰æ‰¾åˆ°ç»“æœä½†å·²å°½åŠ›å°è¯• â†’ is_complete: trueï¼ˆå¹¶åœ¨å›ç­”ä¸­è¯´æ˜ï¼‰"""

PLAN_GUIDED_REACT_PROMPT = """å½“å‰ä»»åŠ¡: {task}

**æ‰§è¡Œè®¡åˆ’ï¼š**
{plan_summary}

**å½“å‰æ­¥éª¤ï¼š** {current_step}

å†å²æ­¥éª¤:
{history}

è¯·æ ¹æ®è®¡åˆ’æ‰§è¡Œå½“å‰æ­¥éª¤ã€‚å¦‚æœå½“å‰æ­¥éª¤å·²å®Œæˆï¼Œç»§ç»­ä¸‹ä¸€æ­¥æˆ–ç»™å‡ºæœ€ç»ˆç­”æ¡ˆã€‚

**é‡ç‚¹å†³ç­–ï¼ˆCRITICALï¼‰ï¼š**
1. **æ— å·¥å…·ä»»åŠ¡**ï¼šå¦‚æœå½“å‰æ­¥éª¤ï¼ˆå¦‚å†™ä»£ç ã€åˆ›ä½œã€æ¨ç†ï¼‰**ä¸éœ€è¦å¤–éƒ¨å·¥å…·**ï¼š
   - **ä¸¥ç¦**æé€ ä¸€ä¸ª Actionã€‚
   - **å¿…é¡»**ä½¿ç”¨ **æ ¼å¼3ï¼ˆæœ€ç»ˆç­”æ¡ˆï¼‰** ç›´æ¥è¾“å‡ºå†…å®¹ã€‚
2. **ç¦æ­¢æ­»å¾ªç¯**ï¼šå¦‚æœä½ ä¸€ç›´åœ¨æ€è€ƒï¼ˆThoughtï¼‰ä½†æ²¡æœ‰è¡ŒåŠ¨ï¼ˆActionï¼‰ï¼Œ**ç«‹å³åœæ­¢**å¹¶ç»™å‡ºæœ€ç»ˆç­”æ¡ˆã€‚
3. **ä¸è¦**å°è¯•åˆ›å»ºä¸€ä¸ª "write code" çš„ actionï¼Œå› ä¸ºä½ æ²¡æœ‰è¿™ä¸ªå·¥å…·ã€‚

ä½ çš„å›å¤å¿…é¡»æ˜¯ä»¥ä¸‹æ ¼å¼ä¹‹ä¸€ï¼š

**æ ¼å¼1 - å·¥å…·è°ƒç”¨ï¼š**
```json
{{
    "thought": "ç®€è¿°å½“å‰åœ¨æ‰§è¡Œè®¡åˆ’çš„å“ªä¸€æ­¥",
    "action": {{
        "tool": "å·¥å…·åç§°",
        "method": "æ–¹æ³•åç§°", 
        "arguments": {{"å‚æ•°å": "å‚æ•°å€¼"}}
    }}
}}
```

**æ ¼å¼2 - å¹¶è¡Œå·¥å…·è°ƒç”¨ï¼ˆç”¨äºå¹¶è¡Œæ­¥éª¤ï¼‰ï¼š**
```json
{{
    "thought": "è¿™äº›æœç´¢ç›¸äº’ç‹¬ç«‹ï¼Œå¹¶è¡Œæ‰§è¡Œ",
    "actions": [
        {{"tool": "websearch_service", "method": "search", "arguments": {{"query": "å…³é”®è¯1"}}}},
        {{"tool": "websearch_service", "method": "search", "arguments": {{"query": "å…³é”®è¯2"}}}}
    ]
}}
```

**æ ¼å¼3 - æœ€ç»ˆç­”æ¡ˆï¼ˆæ— éœ€å·¥å…·æ—¶å¿…é¡»ä½¿ç”¨ï¼‰ï¼š**
```json
{{
    "thought": "è®¡åˆ’å·²å®Œæˆ/ä¸éœ€è¦å·¥å…·/åªå‰©çº¯ä»£ç ç¼–å†™ -> å‡†å¤‡å›ç­”",
     "action": {{
        "tool": "final_answer",
        "arguments": {{}}
    }}
}}
```

è¯·ä¸¥æ ¼æŒ‰ç…§ JSON æ ¼å¼å›å¤ã€‚"""


# =============================================================================
# é”™è¯¯æ¢å¤æç¤º
# =============================================================================

ERROR_RECOVERY_PROMPT = """ä¸Šä¸€æ­¥æ‰§è¡Œå‡ºç°äº†é”™è¯¯ã€‚
é”™è¯¯ä¿¡æ¯: {error}

è¯·åˆ†æé”™è¯¯åŸå› ï¼Œå¹¶å°è¯•ä¿®å¤æˆ–é‡‡å–æ›¿ä»£æ–¹æ¡ˆã€‚
1. å¦‚æœæ˜¯å‚æ•°é”™è¯¯ï¼Œè¯·ä¿®æ­£å‚æ•°é‡è¯•
2. å¦‚æœæ˜¯å·¥å…·ä¸å¯ç”¨ï¼Œè¯·å°è¯•ä½¿ç”¨å…¶ä»–å·¥å…·
3. å¦‚æœæ˜¯æœç´¢æ— ç»“æœï¼Œè¯·å°è¯•æ›´æ¢å…³é”®è¯
4. å¦‚æœæ— æ³•ä¿®å¤ï¼Œè¯·å‘ç”¨æˆ·è¯´æ˜æƒ…å†µ

è¯·ç»§ç»­æŒ‰ç…§ ReAct æ ¼å¼è¾“å‡ºä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚"""

def format_history(history: list[dict]) -> str:
    """æ ¼å¼åŒ–å†å²å¯¹è¯è®°å½•"""
    if not history:
        return "ï¼ˆæ— å†å²è®°å½•ï¼‰"
    
    formatted = []
    for i, step in enumerate(history, 1):
        formatted.append(f"Step {i}:")
        thought = step.get("thought", "")
        if thought:
             formatted.append(f"Thought: {thought}")
        
        actions = step.get("actions", [])
        if actions: # Parallel actions
             for act in actions:
                 tool = act.get("tool", "")
                 args = json.dumps(act.get("arguments", {}), ensure_ascii=False)
                 formatted.append(f"Action: {tool}({args})")
        else: # Single action
             action = step.get("action", {})
             if action:
                 tool = action.get("tool", "")
                 args = json.dumps(action.get("arguments", {}), ensure_ascii=False)
                 formatted.append(f"Action: {tool}({args})")
        
        observations = step.get("observations", [])
        if observations: # Multiple observations
            for obs in observations:
                tool = obs.get("tool", "")
                result = str(obs.get("result", ""))
                formatted.append(f"Observation({tool}): {result}")
        else: # Single observation
             observation = step.get("observation", {})
             if observation:
                 result = str(observation.get("result", ""))
                 formatted.append(f"Observation: {result}")
                 
        formatted.append("---")

    return "\n".join(formatted)

def format_tool_list(tools: list[dict]) -> str:
    """æ ¼å¼åŒ–å·¥å…·åˆ—è¡¨"""
    formatted = []
    for tool in tools:
        name = tool.get("name", "Unknown")
        desc = tool.get("description", "No description")
        args = tool.get("parameters", {})
        is_executable = tool.get("executable", True)
        
        formatted.append(f"### {name}")
        formatted.append(f"æè¿°: {desc}")
        
        if is_executable:
            # å¯æ‰§è¡Œå·¥å…·ï¼šæ˜¾ç¤ºå‚æ•°
            formatted.append(f"å‚æ•°: {json.dumps(args, ensure_ascii=False)}")
            
            # æ˜¾ç¤ºå…³è”çš„å‚è€ƒæ–‡æ¡£
            related_docs = tool.get("related_docs", [])
            if related_docs:
                formatted.append("")
                formatted.append("ğŸ“– **ä½¿ç”¨æŒ‡å—ï¼š**")
                for doc in related_docs:
                    doc_body = doc.get("body", "")
                    # åªå–å‰500å­—ç¬¦é¿å…å¤ªé•¿
                    if len(doc_body) > 500:
                        doc_body = doc_body[:500] + "\n...(æ›´å¤šå†…å®¹çœç•¥)"
                    formatted.append(f"\n{doc_body}")
        else:
            # æ–‡æ¡£ç±»æŠ€èƒ½ï¼šæ˜¾ç¤ºå®Œæ•´å†…å®¹ï¼ˆå¦‚æœæœ‰ï¼‰
            body = tool.get("body", "")
            if body:
                formatted.append(f"\n{body}")
            formatted.append("**æ³¨æ„ï¼šè¿™æ˜¯å‚è€ƒæ–‡æ¡£ï¼Œä¸æ˜¯å¯è°ƒç”¨å·¥å…·**")
        
        formatted.append("")
        
    return "\n".join(formatted)
